var canvas,ctx,mouse={x:0,y:0,px:0,py:0,down:!1},canvas_width=window.innerWidth,canvas_height=600,resolution=30,pen_size=50,num_cols=500,num_rows=canvas_height/resolution,speck_count=6e3,vec_cells=[],particles=[];function init(){canvas=document.getElementById("c"),ctx=canvas.getContext("2d"),canvas.width=window.innerWidth,canvas.height=canvas_height;for(var e=0;e<speck_count;e++)particles.push(new particle(Math.random()*canvas_width,Math.random()*canvas_height));for(var t=0;t<num_cols;t++){vec_cells[t]=[];for(var o=0;o<num_rows;o++){var n=new cell(t*resolution,o*resolution,resolution);vec_cells[t][o]=n,vec_cells[t][o].col=t,vec_cells[t][o].row=o}}for(t=0;t<num_cols;t++)for(o=0;o<num_rows;o++){n=vec_cells[t][o];var s=o-1>=0?o-1:num_rows-1,r=t-1>=0?t-1:num_cols-1,u=t+1<num_cols?t+1:0,c=vec_cells[t][s],a=vec_cells[r][o],i=vec_cells[r][s],l=vec_cells[u][s];n.up=c,n.left=a,n.up_left=i,n.up_right=l,c.down=vec_cells[t][o],a.right=vec_cells[t][o],i.down_right=vec_cells[t][o],l.down_left=vec_cells[t][o]}window.addEventListener("mousedown",mouse_down_handler),window.addEventListener("touchstart",mouse_down_handler),window.addEventListener("mouseup",mouse_up_handler),window.addEventListener("touchend",touch_end_handler),canvas.addEventListener("mousemove",mouse_move_handler),canvas.addEventListener("touchmove",touch_move_handler),window.onload=draw}function update_particle(){for(var e=0;e<particles.length;e++){var t=particles[e];if(t.x>=0&&t.x<canvas_width&&t.y>=0&&t.y<canvas_height){var o=parseInt(t.x/resolution),n=parseInt(t.y/resolution),s=vec_cells[o][n],r=t.x%resolution/resolution,u=t.y%resolution/resolution;t.xv+=(1-r)*s.xv*.05,t.yv+=(1-u)*s.yv*.05,t.xv+=r*s.right.xv*.05,t.yv+=r*s.right.yv*.05,t.xv+=u*s.down.xv*.05,t.yv+=u*s.down.yv*.05,t.x+=t.xv,t.y+=t.yv;var c=t.px-t.x,a=t.py-t.y,i=Math.sqrt(c*c+a*a),l=.5*Math.random();i>l?(ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(t.px,t.py),ctx.stroke()):(ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(t.x+l,t.y+l),ctx.stroke()),t.px=t.x,t.py=t.y}else t.x=t.px=Math.random()*canvas_width,t.y=t.py=Math.random()*canvas_height,t.xv=0,t.yv=0;t.xv*=.5,t.yv*=.5}}function draw(){for(var e=mouse.x-mouse.px,t=mouse.y-mouse.py,o=0;o<vec_cells.length;o++)for(var n=vec_cells[o],s=0;s<n.length;s++){var r=n[s];mouse.down&&change_cell_velocity(r,e,t,pen_size),update_pressure(r)}for(ctx.clearRect(0,0,canvas.width,canvas.height),ctx.strokeStyle="#00FFFF",update_particle(),o=0;o<vec_cells.length;o++)for(n=vec_cells[o],s=0;s<n.length;s++)update_velocity(r=n[s]);mouse.px=mouse.x,mouse.py=mouse.y,requestAnimationFrame(draw)}function change_cell_velocity(e,t,o,n){var s=e.x-mouse.x,r=e.y-mouse.y,u=Math.sqrt(r*r+s*s);if(u<n){u<4&&(u=n);var c=n/u;e.xv+=t*c,e.yv+=o*c}}function update_pressure(e){var t=.5*e.up_left.xv+e.left.xv+.5*e.down_left.xv-.5*e.up_right.xv-e.right.xv-.5*e.down_right.xv,o=.5*e.up_left.yv+e.up.yv+.5*e.up_right.yv-.5*e.down_left.yv-e.down.yv-.5*e.down_right.yv;e.pressure=.25*(t+o)}function update_velocity(e){e.xv+=.25*(.5*e.up_left.pressure+e.left.pressure+.5*e.down_left.pressure-.5*e.up_right.pressure-e.right.pressure-.5*e.down_right.pressure),e.yv+=.25*(.5*e.up_left.pressure+e.up.pressure+.5*e.up_right.pressure-.5*e.down_left.pressure-e.down.pressure-.5*e.down_right.pressure),e.xv*=.99,e.yv*=.99}function cell(e,t,o){this.x=e,this.y=t,this.r=o,this.col=0,this.row=0,this.xv=0,this.yv=0,this.pressure=0}function particle(e,t){this.x=this.px=e,this.y=this.py=t,this.xv=this.yv=0}function mouse_down_handler(e){e.preventDefault(),mouse.down=!0}function mouse_up_handler(){mouse.down=!1}function touch_end_handler(e){e.touches||(mouse.down=!1)}function mouse_move_handler(e){mouse.px=mouse.x,mouse.py=mouse.y,mouse.x=e.offsetX||e.layerX,mouse.y=e.offsetY||e.layerY}function touch_move_handler(e){mouse.px=mouse.x,mouse.py=mouse.y;var t=canvas.getBoundingClientRect();mouse.x=e.touches[0].pageX-t.left,mouse.y=e.touches[0].pageY-t.top}window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame,init();